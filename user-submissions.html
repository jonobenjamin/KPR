<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Submissions - Khwai Private Reserve Monitoring Dashboard</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Custom styles for table page -->
    <style>
        .table-page {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }

        .table-header h2 {
            margin: 0;
            color: #2c3e50;
        }


        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-controls {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .table-filters {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .table-stats {
            display: flex;
            gap: 30px;
        }

        .stat-box {
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            display: block;
        }

        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }

        .submissions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .submissions-table th,
        .submissions-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .submissions-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .submissions-table tr:hover {
            background: #f8f9fa;
        }

        .submissions-table .total-column {
            font-weight: bold;
            color: #3498db;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .date-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-control {
            display: flex;
            flex-direction: column;
        }

        .date-control label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <!-- Top Ribbon -->
    <div class="top-ribbon">
        <h1>Khwai Private Reserve Monitoring Dashboard</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="map4.html" class="submit-data-btn" style="background: #3498db; padding: 8px 16px; text-decoration: none; border-radius: 4px;">
                üó∫Ô∏è Concession Map
            </a>
            <a href="https://jonobenjamin.github.io/WildlifeTracker-Front_End/" target="_blank" class="submit-data-btn">
                Submit Data
            </a>
        </div>
    </div>

    <!-- Table Page Content -->
    <div class="table-page">
        <div class="table-header">
            <h2>User Submissions Report</h2>
        </div>

        <div class="table-container">
            <div class="table-controls">
                <div class="table-filters">
                    <div class="date-controls">
                        <div class="date-control">
                            <label for="start-date">Start Date</label>
                            <input type="date" id="start-date">
                        </div>
                        <div class="date-control">
                            <label for="end-date">End Date</label>
                            <input type="date" id="end-date">
                        </div>
                        <div class="date-control">
                            <label for="month-select">Month</label>
                            <select id="month-select">
                                <option value="">All Months</option>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="date-control">
                            <label for="year-select">Year</label>
                            <select id="year-select">
                                <option value="" selected>All Years</option>
                                <option value="2020">2020</option>
                                <option value="2021">2021</option>
                                <option value="2022">2022</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <button id="refresh-btn" class="btn-primary">Refresh Data</button>
                    </div>
                </div>

                <div class="table-stats">
                    <div class="stat-box">
                        <span class="stat-number" id="total-users">0</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-number" id="total-submissions">0</span>
                        <span class="stat-label">Total Submissions</span>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">
                <div>Loading user submissions data...</div>
            </div>

            <table id="submissions-table" class="submissions-table" style="display: none;">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>No. Sightings</th>
                        <th>No. Maintenance</th>
                        <th>No. Incidents</th>
                        <th class="total-column">Total Submissions</th>
                    </tr>
                </thead>
                <tbody id="submissions-tbody">
                    <!-- Data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bottom Ribbon -->
    <div class="bottom-ribbon">
        <p>¬© 2025 Khwai Private Reserve Monitoring System | Developed by <a href="mailto:jonobenjamingis@gmail.com">@jonathan Benjamin</a></p>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://wildlife-tracker-gxz5.vercel.app';
        const API_KEY = '98394a83034f3db48e5acd3ef54bd622c5748ca5bb4fb3ff39c052319711c9a9';

        // Simple authentication function
        function getAuthHeaders() {
            return {
                'x-api-key': API_KEY,
                'Content-Type': 'application/json'
            };
        }

        let allObservations = [];

        // Load observations data
        async function loadObservations() {
            try {
                console.log('Loading observations...');
                const response = await fetch(`${API_BASE_URL}/api/observations`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error(`Observations API returned ${response.status}`);

                const data = await response.json();
                console.log('Observations data loaded:', data.data ? data.data.length : 0, 'records');

                if (data.success && data.data) {
                    allObservations = data.data;
                    console.log('Data loaded successfully');
                } else {
                    console.log('No data received');
                }

            } catch (error) {
                console.error('Error loading observations:', error);
                showError('Failed to load observation data');
            }
        }

        // Load and display user submissions data
        async function loadUserSubmissions() {
            try {
                console.log('Loading user submissions...');

                // Show loading
                document.getElementById('loading').style.display = 'block';
                document.getElementById('submissions-table').style.display = 'none';

                // Get date filters
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                const selectedMonth = document.getElementById('month-select').value;
                const selectedYear = document.getElementById('year-select').value;

                // Filter observations by date
                const filteredObservations = allObservations.filter(obs => {
                    // Date range filter
                    if (startDate || endDate) {
                        const obsDate = new Date(obs.timestamp);
                        if (startDate && obsDate < new Date(startDate)) return false;
                        if (endDate && obsDate > new Date(endDate + 'T23:59:59')) return false;
                    }

                    // Month/Year filter
                    if (selectedMonth || selectedYear) {
                        const obsDate = new Date(obs.timestamp);
                        if (selectedMonth && obsDate.getMonth() + 1 !== parseInt(selectedMonth)) return false;
                        if (selectedYear && obsDate.getFullYear() !== parseInt(selectedYear)) return false;
                    }

                    return true;
                });

                console.log('Filtered observations:', filteredObservations.length);

                // Aggregate data by user
                const userStats = {};

                filteredObservations.forEach(obs => {
                    const user = obs.user || 'Anonymous';
                    if (!userStats[user]) {
                        userStats[user] = {
                            user: user,
                            sightings: 0,
                            maintenance: 0,
                            incidents: 0,
                            total: 0
                        };
                    }

                    // Count by category
                    if (obs.category === 'Sighting') {
                        userStats[user].sightings++;
                    } else if (obs.category === 'Maintenance') {
                        userStats[user].maintenance++;
                    } else if (obs.category === 'Incident') {
                        userStats[user].incidents++;
                    }

                    userStats[user].total++;
                });

                // Convert to array and sort by total submissions (descending)
                const userArray = Object.values(userStats);
                userArray.sort((a, b) => b.total - a.total);

                console.log('User stats calculated:', userArray.length, 'users');

                // Display the data
                displayUserSubmissions(userArray);

            } catch (error) {
                console.error('Error loading user submissions:', error);
                document.getElementById('loading').innerHTML = '<div style="color: red;">Error loading data. Please try again.</div>';
            }
        }

        // Display user submissions in table
        function displayUserSubmissions(userData) {
            // Hide loading
            document.getElementById('loading').style.display = 'none';
            document.getElementById('submissions-table').style.display = 'table';

            // Update stats
            document.getElementById('total-users').textContent = userData.length;
            const totalSubmissions = userData.reduce((sum, user) => sum + user.total, 0);
            document.getElementById('total-submissions').textContent = totalSubmissions;

            const tbody = document.getElementById('submissions-tbody');

            if (userData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No submissions found for the selected date range</td></tr>';
                return;
            }

            tbody.innerHTML = userData.map(user => `
                <tr>
                    <td>${user.user}</td>
                    <td>${user.sightings}</td>
                    <td>${user.maintenance}</td>
                    <td>${user.incidents}</td>
                    <td class="total-column">${user.total}</td>
                </tr>
            `).join('');
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: #e74c3c;
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                z-index: 1000;
                max-width: 300px;
            `;
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Initialize the page
        async function initPage() {
            try {
                console.log('Initializing user submissions page...');
                await loadObservations();
                await loadUserSubmissions();
                console.log('Page initialized successfully');
            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Failed to initialize page');
            }
        }

        // Set up event listeners
        document.getElementById('refresh-btn').addEventListener('click', loadUserSubmissions);
        document.getElementById('start-date').addEventListener('change', loadUserSubmissions);
        document.getElementById('end-date').addEventListener('change', loadUserSubmissions);
        document.getElementById('month-select').addEventListener('change', loadUserSubmissions);
        document.getElementById('year-select').addEventListener('change', loadUserSubmissions);

        // Start the page
        initPage();
    </script>
</body>
</html>
