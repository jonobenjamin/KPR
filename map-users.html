<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khwai Private Reserve - Wildlife Map</title>
    <script type="module" src="js/firebase-config.js"></script>
    <script src="js/auth-portal.js"></script>
    <script>
      (async function() {
        await window.AuthPortal.checkAuthAndRedirect(false);
      })();
    </script>

    <!-- External CSS -->
    <link rel="stylesheet" href="styles.css" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet TextPath Plugin CSS -->
    <style>
        .leaflet-text-path {
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Top Ribbon -->
    <div class="top-ribbon">
        <h1>Khwai Private Reserve - Wildlife Map</h1>
        <div style="display: flex; gap: 15px; align-items: center;">
            <a href="#" onclick="window.firebasePortal?.signOut?.(window.firebasePortal.auth).then(()=>location.href='login.html'); return false;" class="submit-data-btn" style="background: #666;">Sign Out</a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Map Section -->
        <div class="map-section">
            <div id="loading" class="loading">
                <div>Loading map data...</div>
            </div>
            <div id="map"></div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <h3>Filters & Controls</h3>

            <!-- View Mode - Sightings and Maintenance only -->
            <div class="control-group">
                <h4>View Mode</h4>
                <select id="view-mode-select" class="view-select">
                    <option value="sightings" selected>Sightings</option>
                    <option value="maintenance">Maintenance</option>
                </select>
            </div>

            <!-- Date Range Controls -->
            <div class="control-group">
                <h4>Date Range</h4>
                <div class="date-controls">
                    <div class="date-control">
                        <label for="start-date">Start Date</label>
                        <input type="date" id="start-date">
                    </div>
                    <div class="date-control">
                        <label for="end-date">End Date</label>
                        <input type="date" id="end-date">
                    </div>
                </div>
            </div>

            <!-- Month/Year Selector -->
            <div class="control-group">
                <h4>Month & Year</h4>
                <div class="date-controls">
                    <div class="date-control">
                        <label for="month-select">Month</label>
                        <select id="month-select">
                            <option value="">All Months</option>
                            <option value="01">January</option>
                            <option value="02">February</option>
                            <option value="03">March</option>
                            <option value="04">April</option>
                            <option value="05">May</option>
                            <option value="06">June</option>
                            <option value="07">July</option>
                            <option value="08">August</option>
                            <option value="09">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                    <div class="date-control">
                        <label for="year-select">Year</label>
                        <select id="year-select">
                            <option value="" selected>All Years</option>
                            <option value="2020">2020</option>
                            <option value="2021">2021</option>
                            <option value="2022">2022</option>
                            <option value="2023">2023</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                            <option value="2029">2029</option>
                            <option value="2030">2030</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Species Filter (Sightings only) -->
            <div class="control-group" id="species-group" style="display: block;">
                <h4>Species Filter</h4>
                <div class="species-filter">
                    <select id="species-select">
                        <option value="">All Species</option>
                        <option value="elephant">Elephant</option>
                        <option value="lion">Lion</option>
                        <option value="leopard">Leopard</option>
                        <option value="buffalo">Buffalo</option>
                        <option value="giraffe">Giraffe</option>
                        <option value="zebra">Zebra</option>
                        <option value="wild-dog">Wild Dog</option>
                        <option value="hyena">Hyena</option>
                        <option value="cheetah">Cheetah</option>
                        <option value="hippo">Hippo</option>
                    </select>
                </div>

                <div class="stats-display">
                    <span class="stat-number" id="total-records">0</span>
                    <span class="stat-label">Total Sightings</span>
                </div>

                <div class="control-group">
                    <h4>Display Mode</h4>
                    <div class="switch-container">
                        <label class="switch">
                            <input type="checkbox" id="display-mode-toggle">
                            <span class="slider round">
                                <span class="switch-text" data-on="Hotspots" data-off="Actual">Actual</span>
                            </span>
                        </label>
                    </div>
                </div>

                <div class="latest-toggle">
                    <input type="checkbox" id="latest-sightings-toggle">
                    <label for="latest-sightings-toggle">Show Recent Sightings (This Week)</label>
                </div>
            </div>

            <!-- Maintenance Stats -->
            <div class="control-group" id="maintenance-group" style="display: none;">
                <h4>Maintenance Stats</h4>
                <div class="stats-display">
                    <span class="stat-number" id="maintenance-records">0</span>
                    <span class="stat-label">Total Maintenance</span>
                </div>

                <div class="latest-toggle">
                    <input type="checkbox" id="latest-maintenance-toggle">
                    <label for="latest-maintenance-toggle">Show Recent Maintenance (This Week)</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Ribbon -->
    <div class="bottom-ribbon">
        <p>© 2025 Khwai Private Reserve | Developed by <a href="mailto:jonobenjamingis@gmail.com">@jonathan Benjamin</a></p>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet Heat Plugin -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Leaflet TextPath Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.3/leaflet.textpath.min.js"></script>

    <script>
        // Wildlife Map - Sightings and Maintenance only (no incidents, fire, water, trees)

        const API_BASE_URL = 'https://wildlife-tracker-gxz5.vercel.app';
        const API_KEY = '98394a83034f3db48e5acd3ef54bd622c5748ca5bb4fb3ff39c052319711c9a9';

        function getAuthHeaders() {
            return {
                'x-api-key': API_KEY,
                'Content-Type': 'application/json'
            };
        }

        const map = L.map('map').setView([-18.8, 23.8], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 18,
        }).addTo(map);

        const boundaryLayer = L.layerGroup().addTo(map);
        const roadsLayer = L.layerGroup().addTo(map);
        const campsLayer = L.layerGroup().addTo(map);
        const observationsLayer = L.layerGroup().addTo(map);

        const markersByType = {
            Sighting: [],
            Maintenance: []
        };

        const speciesColors = {
            'elephant': '#8B4513', 'lion': '#DC143C', 'leopard': '#DAA520', 'buffalo': '#228B22',
            'giraffe': '#FF6347', 'zebra': '#000000', 'wild-dog': '#8A2BE2', 'hyena': '#696969',
            'cheetah': '#FFD700', 'hippo': '#4682B4'
        };

        let currentView = 'sightings';
        let displayMode = 'actual';
        let allObservations = [];
        let latestMarkers = [];
        let speciesLegend = null;

        const createCustomIcon = (color) => {
            return L.divIcon({
                className: 'simple-marker',
                html: `<div style="background-color: ${color}; width: 8px; height: 8px; border-radius: 50%; border: 1px solid #000;"></div>`,
                iconSize: [8, 8],
                iconAnchor: [4, 4]
            });
        };

        const sightingIcon = createCustomIcon('#8B4513');
        const maintenanceIcon = createCustomIcon('#DAA520');

        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            document.body.appendChild(errorDiv);
            setTimeout(() => { if (errorDiv.parentNode) errorDiv.parentNode.removeChild(errorDiv); }, 5000);
        }

        async function loadBoundary() {
            try {
                const response = await fetch('data/geojson/boundary.geojson');
                if (!response.ok) throw new Error(`Boundary file not found: ${response.status}`);
                const geoJson = await response.json();
                L.geoJSON(geoJson, {
                    style: { color: '#2D1810', weight: 4, opacity: 0.9, fillColor: '#DEB887', fillOpacity: 0.3 }
                }).addTo(boundaryLayer);
                if (geoJson.features && geoJson.features.length > 0) {
                    const bounds = L.geoJSON(geoJson).getBounds();
                    map.fitBounds(bounds, { padding: [20, 20] });
                }
            } catch (error) {
                console.error('Error loading boundary:', error);
                showError('Failed to load concession boundary data');
            }
        }

        let roadLayers = [];

        function updateRoadLabels() {
            const zoom = map.getZoom();
            const minZoom = 14;
            roadLayers.forEach(({ layer, roadName }) => {
                layer.setText(null);
                if (zoom >= minZoom) {
                    layer.setText('  ' + roadName + '  ', {
                        repeat: false, center: true, offset: 8, below: false,
                        attributes: { 'font-size': '13px', 'font-weight': 'bold', 'font-family': 'Arial, sans-serif', 'fill': '#000', 'stroke': '#fff', 'stroke-width': '3.5', 'paint-order': 'stroke', 'stroke-opacity': '0.9', 'letter-spacing': '1.5' }
                    });
                }
            });
        }

        function shouldReverseCoords(coords) {
            if (!coords || coords.length < 2) return false;
            const start = coords[0], end = coords[coords.length - 1];
            const angle = Math.atan2(end[1] - start[1], end[0] - start[0]) * (180 / Math.PI);
            return (angle > 90 || angle < -90);
        }

        async function loadRoads() {
            try {
                const response = await fetch('data/geojson/KPR_roads.geojson');
                if (!response.ok) throw new Error(`Roads file not found: ${response.status}`);
                const geoJson = await response.json();
                geoJson.features.forEach(feature => {
                    if (feature.geometry && feature.geometry.type === 'MultiLineString') {
                        feature.geometry.coordinates = feature.geometry.coordinates.map(lineString =>
                            shouldReverseCoords(lineString) ? [...lineString].reverse() : lineString);
                    } else if (feature.geometry && feature.geometry.type === 'LineString') {
                        if (shouldReverseCoords(feature.geometry.coordinates)) {
                            feature.geometry.coordinates = [...feature.geometry.coordinates].reverse();
                        }
                    }
                });
                const roadsGeoJson = L.geoJSON(geoJson, {
                    style: { color: '#000', weight: 2, opacity: 0.9 },
                    onEachFeature: function (feature, layer) {
                        const roadName = feature.properties?.Roads || feature.properties?.name;
                        if (roadName) {
                            layer.bindPopup(`<strong>${roadName}</strong>`);
                            roadLayers.push({ layer, roadName });
                        }
                    }
                });
                roadsGeoJson.addTo(roadsLayer);
                map.on('zoomend', updateRoadLabels);
                updateRoadLabels();
            } catch (error) {
                console.error('Error loading roads:', error);
                showError('Failed to load roads data');
            }
        }

        async function loadCamps() {
            try {
                const response = await fetch('data/geojson/Camps.geojson');
                if (!response.ok) throw new Error(`Camps file not found: ${response.status}`);
                const geoJson = await response.json();
                const campIcon = L.icon({
                    iconUrl: 'data/icons/KPR.svg',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24],
                    popupAnchor: [0, -24]
                });
                L.geoJSON(geoJson, {
                    pointToLayer: (feature, latlng) => L.marker(latlng, { icon: campIcon }),
                    onEachFeature: (feature, layer) => {
                        const campName = feature.properties?.Camps || 'Camp';
                        layer.bindPopup(`<strong>${campName}</strong><br><em>Camp Location</em>`);
                    }
                }).addTo(campsLayer);
            } catch (error) {
                console.error('Error loading camps:', error);
                showError('Failed to load camps data');
            }
        }

        async function loadObservations() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/observations`, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error(`Observations API returned ${response.status}`);
                const data = await response.json();

                if (data.success && data.data) {
                    allObservations = data.data;

                    allObservations.forEach(observation => {
                        if (observation.latitude && observation.longitude && (observation.category === 'Sighting' || observation.category === 'Maintenance')) {
                            let icon, popupContent;

                            if (observation.category === 'Sighting') {
                                const animalName = (observation.animal || '').toLowerCase().replace(/\s+/g, '-');
                                const speciesColor = speciesColors[animalName] || '#8B4513';
                                icon = createCustomIcon(speciesColor);
                                popupContent = `<strong>Animal Sighting</strong><br><strong>Species:</strong> ${observation.animal || 'Unknown'}<br><strong>Time:</strong> ${new Date(observation.timestamp).toLocaleString()}<br><strong>Location:</strong> ${observation.latitude.toFixed(4)}, ${observation.longitude.toFixed(4)}`;
                            } else {
                                icon = maintenanceIcon;
                                popupContent = `<strong>Maintenance Activity</strong><br><strong>Type:</strong> ${observation.maintenance_type || 'Unknown'}<br><strong>Time:</strong> ${new Date(observation.timestamp).toLocaleString()}<br><strong>Location:</strong> ${observation.latitude.toFixed(4)}, ${observation.longitude.toFixed(4)}`;
                            }

                            const marker = L.marker([observation.latitude, observation.longitude], { icon }).bindPopup(popupContent);
                            marker.addTo(observationsLayer);
                            if (markersByType[observation.category]) markersByType[observation.category].push(marker);
                        }
                    });

                    applyFilters();
                    updateStats();
                    if (currentView === 'sightings' && displayMode === 'actual') showSpeciesLegend();
                }
            } catch (error) {
                console.error('Error loading observations:', error);
                showError('Failed to load observation data. Check your connection and try again.');
            }
        }

        async function initMap() {
            try {
                await Promise.all([loadBoundary(), loadRoads(), loadCamps(), loadObservations()]);
                hideLoading();
                if (currentView === 'sightings' && displayMode === 'actual') showSpeciesLegend();
            } catch (error) {
                console.error('Error initializing map:', error);
                hideLoading();
                showError('Failed to initialize map data. Check your connection and try again.');
            }
        }

        function clearLatestMarkers() {
            latestMarkers.forEach(marker => {
                if (observationsLayer.hasLayer(marker)) observationsLayer.removeLayer(marker);
            });
            latestMarkers = [];
        }

        function showSpeciesLegend() {
            if (speciesLegend) map.removeControl(speciesLegend);
            speciesLegend = L.control({ position: 'topright' });
            speciesLegend.onAdd = function() {
                const div = L.DomUtil.create('div', 'species-legend');
                div.innerHTML = `<h4>Species Legend</h4>${Object.entries(speciesColors).map(([species, color]) =>
                    `<div class="species-item"><div class="species-dot" style="background-color: ${color}"></div><span class="species-name">${species.replace('-', ' ')}</span></div>`).join('')}`;
                return div;
            };
            speciesLegend.addTo(map);
        }

        function hideSpeciesLegend() {
            if (speciesLegend) {
                map.removeControl(speciesLegend);
                speciesLegend = null;
            }
        }

        function applyFilters() {
            observationsLayer.clearLayers();
            clearLatestMarkers();

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const selectedMonth = document.getElementById('month-select').value;
            const selectedYear = document.getElementById('year-select').value;

            const filteredObservations = allObservations.filter(obs => {
                if (currentView === 'sightings' && obs.category !== 'Sighting') return false;
                if (currentView === 'maintenance' && obs.category !== 'Maintenance') return false;
                if (startDate || endDate) {
                    const obsDate = new Date(obs.timestamp);
                    if (startDate && obsDate < new Date(startDate)) return false;
                    if (endDate && obsDate > new Date(endDate + 'T23:59:59')) return false;
                }
                if (selectedMonth || selectedYear) {
                    const obsDate = new Date(obs.timestamp);
                    if (selectedMonth && obsDate.getMonth() + 1 !== parseInt(selectedMonth)) return false;
                    if (selectedYear && obsDate.getFullYear() !== parseInt(selectedYear)) return false;
                }
                if (currentView === 'sightings') {
                    const selectedSpecies = document.getElementById('species-select').value;
                    if (selectedSpecies) {
                        const obsAnimal = (obs.animal || '').toLowerCase().trim();
                        const filterSpecies = selectedSpecies.toLowerCase().trim();
                        const obsAnimalNormalized = obsAnimal.replace(/\s+/g, '-').replace(/-/g, '');
                        const filterNormalized = filterSpecies.replace(/\s+/g, '-').replace(/-/g, '');
                        if (!obsAnimal.includes(filterSpecies) && !obsAnimalNormalized.includes(filterNormalized) && obsAnimal !== filterSpecies) return false;
                    }
                }
                return true;
            });

            if (displayMode === 'hotspot') {
                const hotspotObservations = filteredObservations.filter(obs => obs.latitude && obs.longitude);
                const points = hotspotObservations.map(obs => [obs.latitude, obs.longitude, 1]);
                if (points.length > 0) {
                    L.heatLayer(points, {
                        radius: 25, blur: 15, maxZoom: 17, minOpacity: 0.6,
                        gradient: { 0.0: '#2c7bb6', 0.25: '#00a6ca', 0.45: '#00ccbc', 0.6: '#90eb9d', 0.75: '#ffff8c', 0.9: '#f9d057', 1.0: '#d7191c' }
                    }).addTo(observationsLayer);
                }
            } else {
                filteredObservations.forEach(observation => {
                    if (observation.latitude && observation.longitude) {
                        let icon, popupContent;
                        if (observation.category === 'Sighting') {
                            const animalName = (observation.animal || '').toLowerCase().replace(/\s+/g, '-');
                            const speciesColor = speciesColors[animalName] || '#8B4513';
                            icon = createCustomIcon(speciesColor);
                            popupContent = `<strong>Animal Sighting</strong><br><strong>Species:</strong> ${observation.animal || 'Unknown'}<br><strong>Time:</strong> ${new Date(observation.timestamp).toLocaleString()}<br><strong>Location:</strong> ${observation.latitude.toFixed(4)}, ${observation.longitude.toFixed(4)}`;
                        } else {
                            icon = maintenanceIcon;
                            popupContent = `<strong>Maintenance Activity</strong><br><strong>Type:</strong> ${observation.maintenance_type || 'Unknown'}<br><strong>Time:</strong> ${new Date(observation.timestamp).toLocaleString()}<br><strong>Location:</strong> ${observation.latitude.toFixed(4)}, ${observation.longitude.toFixed(4)}`;
                        }
                        const marker = L.marker([observation.latitude, observation.longitude], { icon }).bindPopup(popupContent);
                        marker.addTo(observationsLayer);
                    }
                });
            }

            applyLatestFilters();
            updateStats();
            if (currentView === 'sightings' && displayMode === 'actual') showSpeciesLegend();
        }

        function applyLatestFilters() {
            clearLatestMarkers();
            if (document.getElementById('latest-sightings-toggle').checked) showLatestSightings();
            if (document.getElementById('latest-maintenance-toggle').checked) showLatestMaintenance();
        }

        function showLatestSightings() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            allObservations.forEach(obs => {
                const obsDate = new Date(obs.timestamp);
                if (obsDate > oneWeekAgo && obs.latitude && obs.longitude && obs.category === 'Sighting') {
                    const blackPinIcon = L.divIcon({
                        className: 'black-pin-sighting',
                        html: `<div style="background-color: #000000; width: 8px; height: 8px; border-radius: 50%; border: 1px solid #ffffff;"></div>`,
                        iconSize: [8, 8], iconAnchor: [4, 4]
                    });
                    const marker = L.marker([obs.latitude, obs.longitude], { icon: blackPinIcon })
                        .bindPopup(`<strong>Recent Sighting (This Week)</strong><br><strong>Species:</strong> ${obs.animal || 'Unknown'}<br><strong>Time:</strong> ${obsDate.toLocaleString()}<br><strong>Location:</strong> ${obs.latitude.toFixed(4)}, ${obs.longitude.toFixed(4)}`);
                    marker.addTo(observationsLayer);
                    latestMarkers.push(marker);
                }
            });
        }

        function showLatestMaintenance() {
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            allObservations.forEach(obs => {
                const obsDate = new Date(obs.timestamp);
                if (obsDate > oneWeekAgo && obs.latitude && obs.longitude && obs.category === 'Maintenance') {
                    const blackPinIcon = L.divIcon({
                        className: 'black-pin-maintenance',
                        html: `<div style="background-color: #000000; width: 8px; height: 8px; border-radius: 50%; border: 1px solid #ffffff;"></div>`,
                        iconSize: [8, 8], iconAnchor: [4, 4]
                    });
                    const marker = L.marker([obs.latitude, obs.longitude], { icon: blackPinIcon })
                        .bindPopup(`<strong>Recent Maintenance (This Week)</strong><br><strong>Type:</strong> ${obs.maintenance_type || 'Unknown'}<br><strong>Time:</strong> ${obsDate.toLocaleString()}<br><strong>Location:</strong> ${obs.latitude.toFixed(4)}, ${obs.longitude.toFixed(4)}`);
                    marker.addTo(observationsLayer);
                    latestMarkers.push(marker);
                }
            });
        }

        function updateStats() {
            const filteredCount = observationsLayer.getLayers().length - latestMarkers.length;
            if (currentView === 'sightings') document.getElementById('total-records').textContent = filteredCount;
            else if (currentView === 'maintenance') document.getElementById('maintenance-records').textContent = filteredCount;
        }

        function setupFilters() {
            document.getElementById('view-mode-select').addEventListener('change', function() {
                currentView = this.value;
                document.getElementById('species-group').style.display = currentView === 'sightings' ? 'block' : 'none';
                document.getElementById('maintenance-group').style.display = currentView === 'maintenance' ? 'block' : 'none';

                if (displayMode === 'actual' && currentView === 'sightings') showSpeciesLegend();
                else hideSpeciesLegend();

                applyFilters();
            });

            document.getElementById('display-mode-toggle').addEventListener('change', function() {
                displayMode = this.checked ? 'hotspot' : 'actual';
                const switchText = this.parentElement.querySelector('.switch-text');
                switchText.textContent = this.checked ? 'Hotspots' : 'Actual';
                if (displayMode === 'actual' && currentView === 'sightings') showSpeciesLegend();
                else hideSpeciesLegend();
                applyFilters();
            });

            ['start-date', 'end-date', 'month-select', 'year-select'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });

            document.getElementById('species-select').addEventListener('change', applyFilters);

            ['latest-sightings-toggle', 'latest-maintenance-toggle'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyLatestFilters);
            });
        }

        initMap();
        setupFilters();

        window.addEventListener('pageshow', function(event) {
            if (event.persisted && typeof map !== 'undefined') {
                map.invalidateSize();
                if (currentView === 'sightings' && displayMode === 'actual') showSpeciesLegend();
            }
        });
    </script>
</body>
</html>
