<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildlife Tracker Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Custom CSS - Safari Theme -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=Playfair+Display:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            font-family: 'Crimson Text', serif;
            background: linear-gradient(135deg, #2D1810 0%, #8B4513 50%, #DEB887 100%);
            background-attachment: fixed;
            color: #2D1810;
        }

        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            color: #8B4513;
        }

        #map {
            width: 100%;
            height: 100vh;
            border: 3px solid #8B4513;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
        }

        .map-container {
            position: relative;
            width: 100%;
            height: 100vh;
            background: rgba(222, 184, 135, 0.1);
        }

        .page-header {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 2px solid #8B4513;
        }

        .page-header h1 {
            margin: 0;
            font-size: 28px;
            color: #2D1810;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
        }

        .page-header p {
            margin: 5px 0 0 0;
            font-size: 14px;
            color: #8B4513;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            border: 2px solid #8B4513;
            z-index: 1000;
            max-width: 220px;
            backdrop-filter: blur(10px);
        }

        .legend h4 {
            margin: 0 0 15px 0;
            color: #2D1810;
            font-size: 18px;
            border-bottom: 2px solid #DEB887;
            padding-bottom: 8px;
        }

        .filter-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .filter-controls h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
        }

        .filter-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .filter-item:last-child {
            margin-bottom: 0;
        }

        .filter-checkbox {
            margin-right: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }

        .sighting-marker {
            background-color: #8B4513;
        }

        .incident-marker {
            background-color: #DC143C;
        }

        .maintenance-marker {
            background-color: #DAA520;
        }

        .error-message {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="page-header">
        <h1>Wildlife Tracker Map</h1>
        <p>Interactive concession mapping with real-time observations</p>
    </div>

    <div class="map-container">
        <div id="loading" class="loading">
            <div>Loading map data...</div>
        </div>
        <div id="map"></div>

        <div class="legend">
            <h4>Legend</h4>
            <div class="legend-item">
                <div class="legend-color sighting-marker"></div>
                <span>Animal Sighting</span>
            </div>
            <div class="legend-item">
                <div class="legend-color incident-marker"></div>
                <span>Incident</span>
            </div>
            <div class="legend-item">
                <div class="legend-color maintenance-marker"></div>
                <span>Maintenance</span>
            </div>

            <div class="filter-controls">
                <h4>Filters</h4>
                <div class="filter-item">
                    <input type="checkbox" id="filter-sighting" class="filter-checkbox" checked>
                    <label for="filter-sighting">Show Sightings</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-incident" class="filter-checkbox" checked>
                    <label for="filter-incident">Show Incidents</label>
                </div>
                <div class="filter-item">
                    <input type="checkbox" id="filter-maintenance" class="filter-checkbox" checked>
                    <label for="filter-maintenance">Show Maintenance</label>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Simple Wildlife Tracker Map
        // Loads local GeoJSON for boundaries/roads, fetches Firebase observations

        // Configuration
        const API_BASE_URL = 'https://wildlife-tracker-gxz5.vercel.app';
        const API_KEY = '98394a83034f3db48e5acd3ef54bd622c5748ca5bb4fb3ff39c052319711c9a9';

        // Simple authentication function
        function getAuthHeaders() {
            return {
                'x-api-key': API_KEY,
                'Content-Type': 'application/json'
            };
        }

        // Initialize map
        const map = L.map('map').setView([-18.8, 23.8], 10); // Center on concession area

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 18,
        }).addTo(map);

        // Layer groups for different data types
        const boundaryLayer = L.layerGroup().addTo(map);
        const roadsLayer = L.layerGroup().addTo(map);
        const observationsLayer = L.layerGroup().addTo(map);

        // Store markers by type for filtering
        const markersByType = {
            Sighting: [],
            Incident: [],
            Maintenance: []
        };

        // Custom marker icons - Safari theme colors
        const createCustomIcon = (color) => {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${color};
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    border: 3px solid #2D1810;
                    box-shadow: 0 3px 8px rgba(0,0,0,0.4);
                    position: relative;
                ">
                    <div style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 8px;
                        height: 8px;
                        background-color: #2D1810;
                        border-radius: 50%;
                    "></div>
                </div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        };

        const sightingIcon = createCustomIcon('#8B4513');  // Saddle brown for sightings
        const incidentIcon = createCustomIcon('#DC143C');   // Crimson for incidents
        const maintenanceIcon = createCustomIcon('#DAA520'); // Goldenrod for maintenance

        // Hide loading message
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
            document.body.appendChild(errorDiv);

            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Load concession boundary from local file
        async function loadBoundary() {
            try {
                console.log('Loading concession boundary...');
                const response = await fetch('data/geojson/boundary.geojson');
                if (!response.ok) throw new Error(`Boundary file not found: ${response.status}`);

                const geoJson = await response.json();
                console.log('Boundary data loaded:', geoJson);

                L.geoJSON(geoJson, {
                    style: {
                        color: '#2D1810',     // Dark brown border
                        weight: 4,
                        opacity: 0.9,
                        fillColor: '#DEB887',  // Tan fill
                        fillOpacity: 0.3
                    }
                }).addTo(boundaryLayer);

                // Fit map to boundary bounds
                if (geoJson.features && geoJson.features.length > 0) {
                    const bounds = L.geoJSON(geoJson).getBounds();
                    map.fitBounds(bounds, { padding: [20, 20] });
                }

            } catch (error) {
                console.error('Error loading boundary:', error);
                showError('Failed to load concession boundary data');
            }
        }

        // Load roads from local file
        async function loadRoads() {
            try {
                console.log('Loading roads...');
                const response = await fetch('data/geojson/KPR_roads.geojson');
                if (!response.ok) throw new Error(`Roads file not found: ${response.status}`);

                const geoJson = await response.json();
                console.log('Roads data loaded:', geoJson);

                L.geoJSON(geoJson, {
                    style: {
                        color: '#8B4513', // Saddle brown roads
                        weight: 3,
                        opacity: 0.9
                    },
                    onEachFeature: function (feature, layer) {
                        // Add popup with road name when clicked
                        const roadName = feature.properties && (feature.properties.Roads || feature.properties.name);
                        if (roadName) {
                            layer.bindPopup(`<strong>${roadName}</strong>`);

                            // Add road label when zoomed in
                            layer.on('add', function() {
                                if (map.getZoom() > 12) {
                                    addRoadLabel(layer, roadName);
                                }
                            });

                            // Update label on zoom
                            map.on('zoomend', function() {
                                updateRoadLabels();
                            });
                        }
                    }
                }).addTo(roadsLayer);

            } catch (error) {
                console.error('Error loading roads:', error);
                showError('Failed to load roads data');
            }
        }

        // Load observations
        async function loadObservations() {
            try {
                console.log('Loading observations...');
                const response = await fetch(`${API_BASE_URL}/api/observations`, {
                    headers: getAuthHeaders()
                });
                if (!response.ok) throw new Error(`Observations API returned ${response.status}`);

                const data = await response.json();
                console.log('Observations data loaded:', data);

                if (data.success && data.data) {
                    data.data.forEach(observation => {
                        if (observation.latitude && observation.longitude) {
                            let icon, popupContent;

                            switch (observation.category) {
                                case 'Sighting':
                                    icon = sightingIcon;
                                    popupContent = `
                                        <strong>Animal Sighting</strong><br>
                                        Animal: ${observation.animal || 'Unknown'}<br>
                                        Time: ${new Date(observation.timestamp).toLocaleString()}
                                    `;
                                    break;
                                case 'Incident':
                                    icon = incidentIcon;
                                    popupContent = `
                                        <strong>Incident</strong><br>
                                        Type: ${observation.incident_type || 'Unknown'}<br>
                                        Time: ${new Date(observation.timestamp).toLocaleString()}
                                    `;
                                    break;
                                case 'Maintenance':
                                    icon = maintenanceIcon;
                                    popupContent = `
                                        <strong>Maintenance</strong><br>
                                        Type: ${observation.maintenance_type || 'Unknown'}<br>
                                        Time: ${new Date(observation.timestamp).toLocaleString()}
                                    `;
                                    break;
                                default:
                                    icon = sightingIcon;
                                    popupContent = `
                                        <strong>Observation</strong><br>
                                        Category: ${observation.category}<br>
                                        Time: ${new Date(observation.timestamp).toLocaleString()}
                                    `;
                            }

                            const marker = L.marker([observation.latitude, observation.longitude], { icon })
                                .bindPopup(popupContent);

                            // Store marker by type for filtering
                            if (markersByType[observation.category]) {
                                markersByType[observation.category].push(marker);
                                marker.addTo(observationsLayer); // Show by default
                            }
                        }
                    });
                }

            } catch (error) {
                console.error('Error loading observations:', error);
                showError('Failed to load observation data');
            }
        }

        // Initialize map data loading
        async function initMap() {
            try {
                await Promise.all([
                    loadBoundary(),
                    loadRoads(),
                    loadObservations()
                ]);
                hideLoading();
                console.log('Map initialization complete');
            } catch (error) {
                console.error('Error initializing map:', error);
                hideLoading();
                showError('Failed to initialize map data. Check your connection and try again.');
            }
        }

        // Filter functions
        function toggleMarkers(type, show) {
            markersByType[type].forEach(marker => {
                if (show) {
                    if (!observationsLayer.hasLayer(marker)) {
                        marker.addTo(observationsLayer);
                    }
                } else {
                    if (observationsLayer.hasLayer(marker)) {
                        observationsLayer.removeLayer(marker);
                    }
                }
            });
        }

        // Set up filter event listeners
        function setupFilters() {
            // Sighting filter
            document.getElementById('filter-sighting').addEventListener('change', function(e) {
                toggleMarkers('Sighting', e.target.checked);
            });

            // Incident filter
            document.getElementById('filter-incident').addEventListener('change', function(e) {
                toggleMarkers('Incident', e.target.checked);
            });

            // Maintenance filter
            document.getElementById('filter-maintenance').addEventListener('change', function(e) {
                toggleMarkers('Maintenance', e.target.checked);
            });
        }

        // Road label management
        const roadLabels = new Map();

        function addRoadLabel(layer, roadName) {
            // Remove existing label for this layer
            if (roadLabels.has(layer)) {
                map.removeLayer(roadLabels.get(layer));
            }

            // Get the center of the road geometry
            const bounds = layer.getBounds();
            const center = bounds.getCenter();

            // Create label marker
            const label = L.marker(center, {
                icon: L.divIcon({
                    className: 'road-label',
                    html: `<div style="
                        background: rgba(255, 255, 255, 0.9);
                        border: 1px solid #8B4513;
                        border-radius: 3px;
                        padding: 2px 6px;
                        font-size: 11px;
                        font-weight: bold;
                        color: #8B4513;
                        white-space: nowrap;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                    ">${roadName}</div>`,
                    iconSize: null,
                    iconAnchor: [0, 0]
                })
            });

            label.addTo(map);
            roadLabels.set(layer, label);
        }

        function updateRoadLabels() {
            const zoom = map.getZoom();
            roadLabels.forEach((label, layer) => {
                if (zoom > 12) {
                    if (!map.hasLayer(label)) {
                        label.addTo(map);
                    }
                } else {
                    if (map.hasLayer(label)) {
                        map.removeLayer(label);
                    }
                }
            });
        }

        // Start the map
        initMap();
        setupFilters();
    </script>
</body>
</html>
